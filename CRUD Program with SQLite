import sqlite3

class Record:
    def __init__(self):
        self.values = []  

    def readRecord(self, fields):
        self.values = []
        for field in fields:
            value = input(f"Enter {field}: ")
            self.values.append(value)

    def getList(self):
        return self.values

class Framework:
    def __init__(self, menu_file, db_file, table_name):
        self.menu_file = menu_file
        self.db_file = db_file
        self.table_name = table_name  

        self.conn = sqlite3.connect(self.db_file)
        self.cursor = self.conn.cursor()

        self.fields = self.loadfields()

    def loadfields(self):
        self.cursor.execute(f"PRAGMA table_info({self.table_name})")
        fields = [row[1] for row in self.cursor.fetchall()]
        if "id" in fields:
            fields.remove("id")
        return fields

    def showMenu(self):
        with open(self.menu_file, "r") as fpMenu:
            menu = fpMenu.readlines()
        while True:
            for line in menu:
                print(line, end="")
            try:
                choice = int(input(""))
                options = {
                    1: self.create,
                    2: self.read,
                    3: self.update,
                    4: self.delete,
                    5: self.exit
                }
                if choice in options:
                    options[choice]()
                else:
                    print("Invalid choice. Try again.\n")
            except ValueError:
                print("Please enter a number.\n")

    def create(self): 
        record = Record()
        record.readRecord(self.fields)
        placeholders = ", ".join(["?"] * len(self.fields))
        columns = ", ".join([f'"{f}"' for f in self.fields])
        sql = f'INSERT INTO {self.table_name} ({columns}) VALUES ({placeholders})'
        self.cursor.execute(sql, record.getList())
        self.conn.commit()
        print("Record created successfully.\n")

    def read(self):
        self.cursor.execute(f"SELECT * FROM {self.table_name}")
        rows = self.cursor.fetchall()
        if not rows:
            print("No records found.\n")
        else:
            print("\nRecords:")
            all_fields = ["id"] + self.fields
            for index, row in enumerate(rows, start=1):
                print(f"Record #{index}")
                for fieldindex, field in enumerate(all_fields):
                    print(f"  {field}: {row[fieldindex]}")
                print("-" * 30)
            print()

    def getMatchedRecord(self, operation):
        try:
            id_val = input(f"Enter ID for the record to {operation}: ")
            self.cursor.execute(f"SELECT * FROM {self.table_name} WHERE id = ?", (id_val,))
            record = self.cursor.fetchone()
            if record:
                return id_val, record
            else:
                print(f"No record found with ID {id_val}.\n")
                return None, None
        except ValueError:
            print("Invalid input. Please enter a numeric ID.\n")
            return None, None

    def update(self):
        try:
            record_id, record = self.getMatchedRecord("update")
            last_field = self.fields[-1] 
            new_value = input(f"Enter new {last_field}: ")

            sql = f'UPDATE {self.table_name} SET "{last_field}" = ? WHERE id = ?'
            self.cursor.execute(sql, (new_value, record_id))
            self.conn.commit()
            print(" Record updated successfully!\n")
        except sqlite3.Error as e:
            print(f"Database error: {e}\n")

    def delete(self):
        try:
            record_id, record = self.getMatchedRecord("delete")
            self.cursor.execute(f"DELETE FROM {self.table_name} WHERE id = ?", (record_id,))
            self.conn.commit()
            print("Record deleted successfully!\n")
        except sqlite3.Error as e:
            print(f"Database error: {e}\n")


    def exit(self):
        print("Exiting.")
        exit()


def main():
    framework = Framework("menu.cfg", "records.db", "records")
    framework.showMenu()

main()
